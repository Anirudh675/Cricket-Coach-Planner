<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cricket Tactician</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Source+Sans+3:wght@300;400;600&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a1628;--surface:#0f2040;--surface2:#162b50;
  --accent:#f0a500;--green:#1a7a40;--green-light:#2ca65a;
  --text:#e8eaf0;--muted:#7a8aaa;--border:#1e3560;--red:#e03030;
}
body{background:var(--bg);color:var(--text);font-family:'Source Sans 3',sans-serif;min-height:100vh;overflow-x:hidden}

/* LOGIN */
#loginScreen{position:fixed;inset:0;background:linear-gradient(135deg,#071020 0%,#0f2040 60%,#071020 100%);display:flex;align-items:center;justify-content:center;z-index:9999;}
.login-box{background:var(--surface);border:1px solid var(--border);border-top:3px solid var(--accent);border-radius:8px;padding:40px 36px;width:360px;text-align:center;}
.login-logo{font-family:'Oswald',sans-serif;font-size:28px;font-weight:700;color:var(--accent);letter-spacing:3px;margin-bottom:4px}
.login-logo span{color:#fff}
.login-sub{color:var(--muted);font-size:12px;letter-spacing:1px;text-transform:uppercase;margin-bottom:28px}
.login-box input{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:4px;font-size:14px;font-family:'Source Sans 3',sans-serif;margin-bottom:10px;outline:none;transition:border-color .15s}
.login-box input:focus{border-color:var(--accent)}
.login-btn{width:100%;background:var(--accent);color:#000;border:none;padding:11px;border-radius:4px;font-family:'Oswald',sans-serif;font-size:15px;letter-spacing:2px;cursor:pointer;text-transform:uppercase;transition:background .15s;margin-top:4px}
.login-btn:hover{background:#ffc235}
.login-err{color:var(--red);font-size:13px;margin-top:10px;min-height:18px}

/* HEADER */
header{background:linear-gradient(90deg,#071020 0%,#0f2040 50%,#071020 100%);border-bottom:2px solid var(--accent);padding:10px 20px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.logo{font-family:'Oswald',sans-serif;font-size:22px;font-weight:700;color:var(--accent);letter-spacing:2px;text-transform:uppercase}
.logo span{color:#fff}
.subtitle{color:var(--muted);font-size:10px;letter-spacing:1px;text-transform:uppercase}
.match-meta{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.match-meta input,.match-meta select{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:5px 9px;border-radius:4px;font-size:12px;font-family:'Source Sans 3',sans-serif}
.hdr-btn{background:var(--green);color:#fff;border:none;padding:6px 12px;border-radius:4px;font-family:'Oswald',sans-serif;font-size:11px;letter-spacing:1px;cursor:pointer;text-transform:uppercase;transition:background .15s}
.hdr-btn:hover{background:var(--green-light)}
.hdr-btn.save{background:var(--accent);color:#000}.hdr-btn.save:hover{background:#ffc235}
.save-status{font-size:11px;color:var(--muted);min-width:80px}

/* LAYOUT */
.app-layout{display:grid;grid-template-columns:270px 1fr 285px;gap:0;height:calc(100vh - 56px)}
.panel{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.panel.right{border-right:none;border-left:1px solid var(--border)}
.panel-header{background:var(--surface2);border-bottom:1px solid var(--border);padding:9px 13px;font-family:'Oswald',sans-serif;font-size:12px;letter-spacing:1px;text-transform:uppercase;color:var(--accent);display:flex;align-items:center;gap:8px}
.panel-header .badge{background:var(--accent);color:#000;font-size:10px;font-weight:700;padding:2px 6px;border-radius:20px;margin-left:auto}
.panel-body{flex:1;overflow-y:auto;padding:10px;scrollbar-width:thin;scrollbar-color:var(--border) transparent}

/* BUTTONS */
.btn{background:var(--accent);color:#000;border:none;padding:6px 11px;border-radius:4px;font-family:'Oswald',sans-serif;font-size:11px;letter-spacing:1px;cursor:pointer;text-transform:uppercase;transition:background .15s;width:100%}
.btn:hover{background:#ffc235}
.btn.danger{background:transparent;border:1px solid var(--red);color:var(--red);width:auto;padding:2px 7px;font-size:10px}
.btn.danger:hover{background:var(--red);color:#fff}
.btn.sm{width:auto;padding:4px 9px;font-size:10px}
.btn.ghost{background:var(--surface2);color:var(--muted);border:1px solid var(--border)}.btn.ghost:hover{color:var(--text)}

/* PLAYER CARDS */
.add-form{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.add-form input,.add-form select{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:6px 9px;border-radius:4px;font-size:12px;font-family:'Source Sans 3',sans-serif;width:100%}
.player-card{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:7px 9px;margin-bottom:5px;cursor:grab;transition:border-color .15s;user-select:none}
.player-card:hover{border-color:var(--accent)}
.player-card.dragging{opacity:.4}
.pc-top{display:flex;align-items:center;gap:6px}
.player-num{background:var(--accent);color:#000;font-family:'Oswald',sans-serif;font-size:11px;font-weight:700;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.player-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.player-role-tag{font-size:10px;color:var(--muted)}
.cap-badge{background:#f0a500;color:#000;font-size:8px;font-weight:700;padding:1px 4px;border-radius:3px;font-family:'Oswald',sans-serif;letter-spacing:.5px}
.vc-badge{background:#8b5cf6;color:#fff;font-size:8px;font-weight:700;padding:1px 4px;border-radius:3px;font-family:'Oswald',sans-serif;letter-spacing:.5px}
.pc-actions{display:flex;gap:4px;margin-top:5px;align-items:center;flex-wrap:wrap}
.pc-actions button{background:var(--surface);border:1px solid var(--border);color:var(--muted);font-size:9px;padding:2px 6px;border-radius:3px;cursor:pointer;font-family:'Oswald',sans-serif;letter-spacing:.5px;transition:all .15s}
.pc-actions button:hover{border-color:var(--accent);color:var(--accent)}
.pc-actions button.active-cap{border-color:#f0a500;color:#f0a500;background:rgba(240,165,0,.12)}
.pc-actions button.active-vc{border-color:#8b5cf6;color:#8b5cf6;background:rgba(139,92,246,.12)}
.note-toggle{font-size:9px;color:var(--muted);cursor:pointer;text-decoration:underline;margin-left:4px}
.note-toggle:hover{color:var(--accent)}
.player-note-area textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:5px 7px;border-radius:3px;font-size:11px;font-family:'Source Sans 3',sans-serif;resize:none;height:52px;display:none;margin-top:5px;outline:none}
.player-note-area textarea:focus{border-color:var(--accent)}

/* FIELD */
.field-area{background:#071020;display:flex;flex-direction:column;align-items:center;overflow:auto;position:relative}
.field-controls{width:100%;background:var(--surface2);border-bottom:1px solid var(--border);padding:7px 14px;display:flex;align-items:center;gap:8px;flex-shrink:0;flex-wrap:wrap}
.ctrl-label{font-family:'Oswald',sans-serif;font-size:11px;letter-spacing:1px;color:var(--muted);text-transform:uppercase}
.field-controls select{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:4px;font-size:11px;font-family:'Source Sans 3',sans-serif}
.field-wrap{position:relative;width:470px;height:470px;margin:14px auto;flex-shrink:0}
.field-svg{width:100%;height:100%}
.fielder-token{position:absolute;width:40px;height:40px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:move;transform:translate(-50%,-50%);user-select:none;z-index:10;transition:box-shadow .12s}
.fielder-token:hover{box-shadow:0 0 0 3px var(--accent)}
.tok-name{font-size:8px;font-weight:700;text-align:center;line-height:1.1;max-width:38px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.9)}
.tok-pos{font-size:7px;color:rgba(255,255,255,.8);text-align:center;max-width:38px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tok-badge{position:absolute;top:-5px;right:-4px;font-size:7px;font-weight:700;width:13px;height:13px;border-radius:50%;display:flex;align-items:center;justify-content:center}
.field-legend{display:flex;gap:12px;margin:0 auto 10px;flex-wrap:wrap;justify-content:center;font-size:10px;color:var(--muted)}
.field-legend span{display:flex;align-items:center;gap:4px}
.legend-dot{width:8px;height:8px;border-radius:50%}

/* Position popup */
.pos-edit-popup{position:absolute;background:var(--surface2);border:1px solid var(--accent);border-radius:6px;padding:10px;z-index:200;display:none;width:175px}
.pos-edit-popup input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:5px 8px;border-radius:3px;font-size:12px;font-family:'Source Sans 3',sans-serif;margin-bottom:6px;outline:none}
.pos-edit-popup input:focus{border-color:var(--accent)}

/* ORDER PANELS */
.tabs{display:flex;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0}
.tab{flex:1;padding:8px 4px;font-family:'Oswald',sans-serif;font-size:10px;letter-spacing:.5px;text-transform:uppercase;color:var(--muted);cursor:pointer;text-align:center;border-bottom:2px solid transparent;transition:all .15s}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-content{display:none}
.tab-content.active{display:block}
.order-section{margin-bottom:12px}
.order-title{font-family:'Oswald',sans-serif;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);padding:5px 0;border-bottom:1px solid var(--border);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
.order-slot{background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:5px 8px;margin-bottom:3px;display:flex;align-items:center;gap:6px;font-size:12px;min-height:32px;transition:border-color .15s}
.order-slot.over{border-color:var(--accent);background:rgba(240,165,0,.08)}
.order-slot.empty{border-style:dashed;color:var(--muted);font-size:10px;justify-content:center}
.slot-num{font-family:'Oswald',sans-serif;font-size:11px;color:var(--muted);width:15px;text-align:right;flex-shrink:0}
.slot-name{flex:1;font-weight:600;font-size:11px}
.slot-role{font-size:10px;color:var(--muted)}
.remove-slot{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;line-height:1;padding:0 2px;transition:color .15s}
.remove-slot:hover{color:var(--red)}
.bowler-row{display:flex;align-items:center;gap:4px;margin-bottom:3px}
.over-count{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:3px 5px;font-size:11px;width:44px;color:var(--text);font-family:'Source Sans 3',sans-serif;text-align:center}
.notes-area textarea{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px;border-radius:4px;font-size:11px;font-family:'Source Sans 3',sans-serif;resize:vertical;min-height:65px;outline:none}
.notes-area textarea:focus{border-color:var(--accent)}
.info-box{background:rgba(240,165,0,.07);border:1px solid rgba(240,165,0,.18);border-radius:4px;padding:6px 8px;font-size:10px;color:var(--muted);margin-bottom:7px;line-height:1.5}
.section-divider{border:none;border-top:1px solid var(--border);margin:8px 0}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* AI TAB */
.ai-section{margin-bottom:10px;border:1px solid rgba(167,139,250,.2);border-radius:6px;overflow:hidden}
.ai-section-title{background:rgba(124,58,237,.15);padding:6px 10px;font-family:'Oswald',sans-serif;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:#a78bfa;display:flex;align-items:center;gap:6px}
.ai-section-body{padding:8px 10px;font-size:11px;line-height:1.7;color:var(--text)}
.ai-player-row{display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.ai-player-row:last-child{border-bottom:none}
.ai-pos-tag{background:rgba(124,58,237,.2);color:#a78bfa;font-size:9px;padding:1px 5px;border-radius:3px;font-family:'Oswald',sans-serif;white-space:nowrap}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">Cricket <span>Tactician</span></div>
    <div class="login-sub">Coach Access Only</div>
    <input type="text" id="loginUser" placeholder="Username" autocomplete="off" onkeydown="if(event.key==='Enter')doLogin()">
    <input type="password" id="loginPass" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none">

<header>
  <div>
    <div class="logo">Cricket <span>Tactician</span></div>
    <div class="subtitle">Match Strategy Planner</div>
  </div>
  <div class="match-meta">
    <input type="text" id="teamName" placeholder="Team Name" oninput="scheduleSave()" style="width:120px">
    <input type="text" id="opponent" placeholder="vs. Opponent" oninput="scheduleSave()" style="width:120px">
    <select id="matchType" onchange="scheduleSave()">
      <option>T20</option><option>ODI</option><option>Test</option><option>T10</option>
    </select>
    <input type="text" id="venue" placeholder="Venue" oninput="scheduleSave()" style="width:110px">
  </div>
  <button class="hdr-btn save" onclick="saveToCloud()">üíæ Save</button>
  <button class="hdr-btn" onclick="exportPlan()">üìÑ Export</button>
  <button class="hdr-btn" style="background:#c0392b" onclick="doLogout()">Logout</button>
  <div class="save-status" id="saveStatus"></div>
</header>

<div class="app-layout">

  <!-- LEFT: ROSTER -->
  <div class="panel">
    <div class="panel-header">üèè Squad Roster <span class="badge" id="rosterCount">0</span></div>
    <div class="panel-body">
      <div class="add-form">
        <input type="text" id="newPlayerName" placeholder="Player name..." onkeydown="if(event.key==='Enter')addPlayer()">
        <select id="newPlayerRole">
          <option>Batsman</option><option>Bowler</option><option>All-rounder</option><option>Wicket-keeper</option>
        </select>
        <button class="btn" onclick="addPlayer()">+ Add Player</button>
      </div>
      <div id="rosterList"></div>
    </div>
  </div>

  <!-- CENTER: FIELD -->
  <div class="field-area">
    <div class="field-controls">
      <span class="ctrl-label">Preset:</span>
      <select onchange="applyPreset(this.value)">
        <option value="custom">Custom</option>
        <option value="attack">Attacking</option>
        <option value="defend">Defensive</option>
        <option value="spin">Spin Trap</option>
      </select>
      <span class="ctrl-label">End:</span>
      <select id="bowlingEnd" onchange="scheduleSave()"><option>Over</option><option>Round</option></select>
      <button class="btn sm ghost" onclick="resetFieldAssignments()">Clear Fielders</button>
      <button class="btn sm" onclick="resetAllPositions()">Reset Positions</button>
    </div>

    <div class="field-wrap" id="fieldWrap">
      <svg class="field-svg" viewBox="0 0 500 500">
        <!-- Outfield -->
        <ellipse cx="250" cy="250" rx="240" ry="240" fill="#1a5c2a"/>
        <!-- 30-yard circle -->
        <ellipse cx="250" cy="250" rx="160" ry="160" fill="#1e6830" stroke="#2d8c42" stroke-width="1.5" stroke-dasharray="6,4"/>
        <!-- Pitch -->
        <rect x="228" y="155" width="44" height="190" rx="4" fill="#c8a850" opacity="0.6"/>
        <!-- Crease lines -->
        <line x1="218" y1="200" x2="282" y2="200" stroke="#fff" stroke-width="1.5" opacity="0.6"/>
        <line x1="218" y1="300" x2="282" y2="300" stroke="#fff" stroke-width="1.5" opacity="0.6"/>
        <!-- Stumps top (bowler's end) -->
        <rect x="241" y="182" width="3" height="15" fill="#e0c070"/><rect x="248" y="182" width="3" height="15" fill="#e0c070"/><rect x="255" y="182" width="3" height="15" fill="#e0c070"/>
        <!-- Stumps bottom (batting end ‚Äî WK stands behind these at top) -->
        <rect x="241" y="303" width="3" height="15" fill="#e0c070"/><rect x="248" y="303" width="3" height="15" fill="#e0c070"/><rect x="255" y="303" width="3" height="15" fill="#e0c070"/>
        <!-- Pitch end labels -->
        <text x="250" y="174" text-anchor="middle" fill="#ffffff38" font-size="7.5" font-family="sans-serif">‚Üì BATTER</text>
        <text x="250" y="332" text-anchor="middle" fill="#ffffff38" font-size="7.5" font-family="sans-serif">BOWLER ‚Üë</text>
        <!-- Boundary -->
        <ellipse cx="250" cy="250" rx="238" ry="238" fill="none" stroke="#fff" stroke-width="1.5" opacity="0.2" stroke-dasharray="10,6"/>

        <!-- Side labels -->
        <text x="466" y="258" text-anchor="middle" fill="#ffffff45" font-size="9" font-family="sans-serif" transform="rotate(90,466,258)">‚óÄ‚îÄ‚îÄ Off Side</text>
        <text x="34" y="258" text-anchor="middle" fill="#ffffff45" font-size="9" font-family="sans-serif" transform="rotate(-90,34,258)">Leg Side ‚îÄ‚îÄ‚ñ∂</text>
      </svg>
      <div id="fieldTokens"></div>
      <div class="pos-edit-popup" id="posPopup">
        <div style="font-size:10px;color:var(--muted);margin-bottom:4px;font-family:'Oswald',sans-serif;letter-spacing:1px">RENAME POSITION</div>
        <input type="text" id="posNameInput" placeholder="e.g. Slip" onkeydown="if(event.key==='Enter')confirmPosName()">
        <div style="display:flex;gap:5px">
          <button class="btn" style="flex:1;padding:4px" onclick="confirmPosName()">Set</button>
          <button class="btn ghost" style="flex:1;padding:4px" onclick="closePosPopup()">Cancel</button>
        </div>
      </div>
    </div>

    <div class="field-legend">
      <span><span class="legend-dot" style="background:#f59e0b"></span>Keeper</span>
      <span><span class="legend-dot" style="background:#3b82f6"></span>Bowler</span>
      <span><span class="legend-dot" style="background:#10b981"></span>Batsman</span>
      <span><span class="legend-dot" style="background:#8b5cf6"></span>All-rounder</span>
      <span style="font-size:9px;color:var(--border)">Right-click token to rename position</span>
    </div>
  </div>

  <!-- RIGHT: ORDERS -->
  <div class="panel right">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('batting')">üèè Batting</div>
      <div class="tab" onclick="switchTab('bowling')">üé≥ Bowling</div>
      <div class="tab" onclick="switchTab('notes')">üìã Notes</div>
      <div class="tab" onclick="switchTab('ai')" style="color:#a78bfa">ü§ñ AI</div>
    </div>
    <div class="panel-body">

      <div class="tab-content active" id="tab-batting">
        <div class="info-box">Drag players into batting slots. C and VC set from the roster panel.</div>
        <div class="order-section">
          <div class="order-title">Batting Order
            <span style="font-size:9px;color:var(--accent);cursor:pointer" onclick="clearBatting()">Clear All</span>
          </div>
          <div id="battingOrder"></div>
        </div>
      </div>

      <div class="tab-content" id="tab-bowling">
        <div class="info-box">Assign bowlers and overs below, or run <strong>AI Suggestions</strong> from the ü§ñ AI tab first for smarter rotation.</div>
        <div class="order-section">
          <div class="order-title">Bowling Rotation
            <span style="font-size:9px;color:var(--accent);cursor:pointer" onclick="clearBowling()">Clear All</span>
          </div>
          <div id="bowlingOrder"></div>
          <button class="btn" style="margin-top:5px" onclick="addBowlingSlot()">+ Add Bowler Slot</button>
        </div>
        <hr class="section-divider">
        <div class="order-section">
          <div class="order-title">Over-by-Over Plan</div>
          <div id="overPlan"></div>
          <div style="display:flex;gap:6px;margin-top:6px;align-items:center">
            <span style="font-size:10px;color:var(--muted)">Overs:</span>
            <input type="number" id="totalOvers" value="20" min="1" max="90"
              style="background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:4px;border-radius:4px;width:50px;font-family:'Source Sans 3',sans-serif;font-size:12px">
            <button class="btn" style="flex:1;background:linear-gradient(135deg,#7c3aed,#a78bfa);color:#fff" onclick="generateOverPlanAI()">‚ú® AI Generate</button>
          </div>
          <div style="font-size:9px;color:var(--muted);margin-top:4px;text-align:center">Uses AI suggestions if available, otherwise uses bowler slots above</div>
        </div>
      </div>

      <div class="tab-content" id="tab-notes">
        <div class="order-section">
          <div class="order-title">Match Strategy</div>
          <div class="notes-area"><textarea id="noteStrategy" placeholder="General match strategy, opponent analysis..." oninput="scheduleSave()"></textarea></div>
        </div>
        <div class="order-section">
          <div class="order-title">Batting Notes</div>
          <div class="notes-area"><textarea id="noteBatting" placeholder="Power play, key partnerships..." oninput="scheduleSave()"></textarea></div>
        </div>
        <div class="order-section">
          <div class="order-title">Bowling Notes</div>
          <div class="notes-area"><textarea id="noteBowling" placeholder="Death plan, pitch conditions..." oninput="scheduleSave()"></textarea></div>
        </div>
      </div>

      <!-- AI TAB -->
      <div class="tab-content" id="tab-ai">
        <div class="info-box" style="border-color:rgba(167,139,250,.3);background:rgba(167,139,250,.07)">
          AI reads your <strong>player notes</strong> and generates smart suggestions for batting order, bowling rotation, and field placement. Add notes to players first!
        </div>
        <div class="order-section">
          <div class="order-title">Match Context <span style="font-size:9px;color:var(--muted)">(optional)</span></div>
          <textarea id="aiContext" placeholder="e.g. Batting first on a flat pitch, T20, opposition has strong top order..."
            style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px;border-radius:4px;font-size:11px;font-family:'Source Sans 3',sans-serif;resize:none;height:55px;outline:none"></textarea>
        </div>
        <button class="btn" style="background:linear-gradient(135deg,#7c3aed,#a78bfa);color:#fff;margin-bottom:10px" onclick="askGroq()">
          ‚ú® Generate AI Suggestions
        </button>
        <div id="aiLoading" style="display:none;text-align:center;padding:20px;color:#a78bfa;font-size:12px">
          <div style="margin-bottom:8px">ü§ñ Analysing your squad...</div>
          <div style="width:100%;height:3px;background:var(--surface2);border-radius:3px;overflow:hidden">
            <div id="aiLoadBar" style="height:100%;width:0%;background:linear-gradient(90deg,#7c3aed,#a78bfa);border-radius:3px;transition:width 3s ease"></div>
          </div>
        </div>
        <div id="aiResult" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-family:'Oswald',sans-serif;font-size:11px;letter-spacing:1px;color:#a78bfa;text-transform:uppercase">AI Suggestions</div>
            <button class="btn sm" style="background:#7c3aed;color:#fff" onclick="applyAISuggestions()">Apply to Plan</button>
          </div>
          <div id="aiResultBody" style="background:var(--surface2);border:1px solid rgba(167,139,250,.25);border-radius:6px;padding:10px;font-size:11px;line-height:1.7;color:var(--text);white-space:pre-wrap;max-height:380px;overflow-y:auto"></div>
        </div>
      </div>

    </div>
  </div>
</div>
</div>

<script>
// ===== CONFIG =====
const GROQ_API_KEY = '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';
const GROQ_URL = 'https://api.groq.com/openai/v1/chat/completions';
const GROQ_MODEL = 'llama-3.3-70b-versatile';
const JSONBIN_BIN_ID = '699bc37443b1c97be9954142';
const JSONBIN_KEY = '$2a$10$VTvyef8T.8ndFiPL1ExJVOPuU3yqWvspn/t45SrdaUUmNb8fU6RkC';
const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

// ===== LOGIN =====
function doLogin() {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  if (u === 'coach' && p === 'Gwsc123@') {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    loadFromCloud();
  } else {
    document.getElementById('loginErr').textContent = 'Incorrect username or password.';
    document.getElementById('loginPass').value = '';
  }
}
function doLogout() {
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  document.getElementById('loginErr').textContent = '';
}

// ===== STATE =====
let players = [];
let nextId = 1;
let captainId = null;
let vcId = null;
let battingOrder = new Array(11).fill(null);
let bowlingSlots = Array.from({length:5}, () => ({playerId:null, overs:4}));
let fieldPositions = [
  // WK at top-centre behind batting stumps; batter is below (y~65), bowler at top (y~35)
  // Off side = right (cx+), Leg side = left (cx-)
  {id:0,  x:50, y:22, playerId:null, posName:"Wicket-keeper"},
  {id:1,  x:61, y:20, playerId:null, posName:"First Slip"},
  {id:2,  x:73, y:30, playerId:null, posName:"Gully"},
  {id:3,  x:79, y:44, playerId:null, posName:"Point"},
  {id:4,  x:75, y:57, playerId:null, posName:"Cover Point"},
  {id:5,  x:68, y:67, playerId:null, posName:"Cover"},
  {id:6,  x:60, y:78, playerId:null, posName:"Mid Off"},
  {id:7,  x:40, y:78, playerId:null, posName:"Mid On"},
  {id:8,  x:28, y:67, playerId:null, posName:"Mid Wicket"},
  {id:9,  x:22, y:50, playerId:null, posName:"Square Leg"},
  {id:10, x:37, y:22, playerId:null, posName:"Fine Leg"}
];
let dragPlayerId = null;
let saveTimer = null;
let editingPosIdx = null;

// ===== HELPERS =====
function roleColor(r){
  if(r==='Wicket-keeper') return '#f59e0b';
  if(r==='Bowler') return '#3b82f6';
  if(r==='All-rounder') return '#8b5cf6';
  return '#10b981';
}
function playerById(id){return players.find(p=>p.id===id);}
function shortName(n){const p=n.split(' ');return p.length===1?p[0].slice(0,7):p[0][0]+'. '+p[p.length-1].slice(0,7);}

// ===== AUTO POSITION NAME =====
// Coordinate system:
//   x=0 LEFT = LEG SIDE,  x=100 RIGHT = OFF SIDE
//   y=0 TOP = WK/slip end (behind batting stumps),  y=100 BOTTOM = long on/off
//   Batter faces upward toward bowler. WK behind batter at top (y~22).
function detectPosition(x, y) {
  const cx = x - 50; // + = off side (right), - = leg side (left)
  const dist = Math.sqrt(cx*cx + (y-50)*(y-50));

  // WK / SLIP CORDON ‚Äî top area, y < 33
  if (y < 33) {
    if (Math.abs(cx) < 6)        return "Wicket-keeper";
    if (cx > 6  && cx <= 15)     return "First Slip";
    if (cx > 15 && cx <= 25)     return "Second Slip";
    if (cx > 25)                 return "Third Slip";
    if (cx < -6  && cx >= -15)   return "Leg Slip";
    if (cx < -15)                return "Leg Gully";
  }

  // GULLY ‚Äî off side, upper quadrant y 30‚Äì44, wide of slip
  if (y >= 28 && y < 44 && cx > 18 && cx < 36) return "Gully";

  // SILLY MID positions ‚Äî very close to batter
  if (dist < 14) {
    if (cx > 3)  return "Silly Mid Off";
    if (cx < -3) return "Silly Mid On";
    return "Short Pitch";
  }

  // INNER RING ‚Äî 30-yard circle (dist 14‚Äì38)
  if (dist < 38) {
    if (y < 50) {
      // Upper half: WK-to-batter zone
      if (cx > 24)       return "Point";
      if (cx > 10)       return "Cover Point";
      if (cx < -24)      return "Square Leg";
      if (cx < -10)      return "InField";
      return cx >= 0 ? "Cover Point" : "Square Leg";
    } else {
      // Lower half: batter-facing outfield side
      if (cx > 24)       return "Extra Cover";
      if (cx > 10)       return "Cover";
      if (cx < -24)      return "Mid Wicket";
      if (cx < -10)      return "InField";
      return cx >= 0 ? "Mid Off" : "Mid On";
    }
  }

  // OUTFIELD ‚Äî dist >= 38
  // Top (behind WK): fine leg / third man
  if (y < 28) {
    return cx < 0 ? "Fine Leg" : "Third Man";
  }
  // Off side outfield (right)
  if (cx > 28) {
    if (y < 45) return "Deep Point";
    if (y < 62) return "OutField";
    return "Deep Extra Cover";
  }
  // Leg side outfield (left)
  if (cx < -28) {
    if (y < 45) return "Deep Square Leg";
    if (y < 62) return "Deep Square";
    return "Deep Mid Wicket";
  }
  // Bottom: long on / long off
  if (y >= 74) {
    return cx >= 0 ? "Long Off" : "Long On";
  }
  return cx >= 0 ? "Cover" : "Mid Wicket";
}

// ===== CLOUD SAVE / LOAD =====
function getState() {
  return {
    players, nextId, captainId, vcId, battingOrder, bowlingSlots, fieldPositions,
    matchMeta: {
      teamName: document.getElementById('teamName').value,
      opponent:  document.getElementById('opponent').value,
      matchType: document.getElementById('matchType').value,
      venue:     document.getElementById('venue').value,
      bowlingEnd:document.getElementById('bowlingEnd').value,
    },
    notes: {
      strategy: document.getElementById('noteStrategy').value,
      batting:  document.getElementById('noteBatting').value,
      bowling:  document.getElementById('noteBowling').value,
    },
    totalOvers: document.getElementById('totalOvers').value,
  };
}

function applyState(s) {
  if (!s) return;
  players       = (s.players||[]).map(p=>({note:'', ...p}));
  nextId        = s.nextId || players.length + 1;
  captainId     = s.captainId || null;
  vcId          = s.vcId || null;
  battingOrder  = s.battingOrder || new Array(11).fill(null);
  bowlingSlots  = s.bowlingSlots || Array.from({length:5},()=>({playerId:null,overs:4}));
  fieldPositions= s.fieldPositions || fieldPositions;
  if (s.matchMeta) {
    document.getElementById('teamName').value  = s.matchMeta.teamName||'';
    document.getElementById('opponent').value  = s.matchMeta.opponent||'';
    document.getElementById('matchType').value = s.matchMeta.matchType||'T20';
    document.getElementById('venue').value     = s.matchMeta.venue||'';
    document.getElementById('bowlingEnd').value= s.matchMeta.bowlingEnd||'Over';
  }
  if (s.notes) {
    document.getElementById('noteStrategy').value = s.notes.strategy||'';
    document.getElementById('noteBatting').value  = s.notes.batting||'';
    document.getElementById('noteBowling').value  = s.notes.bowling||'';
  }
  if (s.totalOvers) document.getElementById('totalOvers').value = s.totalOvers;
  renderAll();
}

async function saveToCloud() {
  setSaveStatus('Saving...','#f0a500');
  try {
    const res = await fetch(JSONBIN_URL, {
      method:'PUT',
      headers:{'Content-Type':'application/json','X-Master-Key':JSONBIN_KEY},
      body:JSON.stringify(getState())
    });
    setSaveStatus(res.ok?'‚úì Saved':'Save failed', res.ok?'#2ca65a':'#e03030');
    if(res.ok) setTimeout(()=>setSaveStatus('',''),3000);
  } catch(e) {
    setSaveStatus('Offline','#e03030');
  }
}

async function loadFromCloud() {
  setSaveStatus('Loading...','#f0a500');
  try {
    const res = await fetch(JSONBIN_URL+'/latest', {headers:{'X-Master-Key':JSONBIN_KEY}});
    if (res.ok) {
      const data = await res.json();
      if (data.record && data.record.players) {
        applyState(data.record);
        setSaveStatus('‚úì Loaded','#2ca65a');
        setTimeout(()=>setSaveStatus('',''),3000);
        return;
      }
    }
    loadDefaults();
    setSaveStatus('New session','#7a8aaa');
    setTimeout(()=>setSaveStatus('',''),3000);
  } catch(e) {
    loadDefaults();
    setSaveStatus('Offline ‚Äì defaults','#7a8aaa');
    setTimeout(()=>setSaveStatus('',''),3000);
  }
}

function loadDefaults() {
  players = [
    {id:1,name:"Rohit Sharma",role:"Batsman",note:""},
    {id:2,name:"Shubman Gill",role:"Batsman",note:""},
    {id:3,name:"Virat Kohli",role:"Batsman",note:""},
    {id:4,name:"Suryakumar Yadav",role:"Batsman",note:""},
    {id:5,name:"Hardik Pandya",role:"All-rounder",note:""},
    {id:6,name:"Rishabh Pant",role:"Wicket-keeper",note:""},
    {id:7,name:"Ravindra Jadeja",role:"All-rounder",note:""},
    {id:8,name:"Axar Patel",role:"Bowler",note:""},
    {id:9,name:"Jasprit Bumrah",role:"Bowler",note:""},
    {id:10,name:"Mohammed Shami",role:"Bowler",note:""},
    {id:11,name:"Kuldeep Yadav",role:"Bowler",note:""},
  ];
  nextId = 12;
  renderAll();
}

function setSaveStatus(msg, color) {
  const el = document.getElementById('saveStatus');
  el.textContent = msg;
  el.style.color = color||'var(--muted)';
}
function scheduleSave() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveToCloud, 2500);
}

// ===== ROSTER =====
function renderRoster() {
  const list = document.getElementById('rosterList');
  list.innerHTML = '';
  document.getElementById('rosterCount').textContent = players.length;
  players.forEach((p, i) => {
    if (!p.note) p.note = '';
    const isCap = captainId === p.id;
    const isVC  = vcId === p.id;
    const card = document.createElement('div');
    card.className = 'player-card';
    card.draggable = true;
    card.dataset.pid = p.id;
    card.innerHTML = `
      <div class="pc-top">
        <div class="player-num">${i+1}</div>
        <div style="width:8px;height:8px;border-radius:50%;background:${roleColor(p.role)};flex-shrink:0"></div>
        <div style="flex:1;min-width:0">
          <div class="player-name">${p.name}${isCap?' <span class="cap-badge">C</span>':''}${isVC?' <span class="vc-badge">VC</span>':''}</div>
          <div class="player-role-tag">${p.role}</div>
        </div>
        <button class="btn danger" onclick="removePlayer(${p.id},event)">‚úï</button>
      </div>
      <div class="pc-actions">
        <button onclick="setCaptain(${p.id})" class="${isCap?'active-cap':''}">üëë CAP</button>
        <button onclick="setVC(${p.id})" class="${isVC?'active-vc':''}">üéñ VC</button>
        <span class="note-toggle" onclick="toggleNote(${p.id})">üìù Note</span>
      </div>
      <div class="player-note-area">
        <textarea id="noteText${p.id}" placeholder="Player notes..."
          onchange="savePlayerNote(${p.id})"
        >${p.note}</textarea>
      </div>
    `;
    card.addEventListener('dragstart', (e) => {
      dragPlayerId = p.id;
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'copy';
    });
    card.addEventListener('dragend', () => {
      dragPlayerId = null;
      card.classList.remove('dragging');
    });
    list.appendChild(card);
  });
}

function toggleNote(id) {
  const ta = document.getElementById(`noteText${id}`);
  if (!ta) return;
  ta.style.display = ta.style.display === 'block' ? 'none' : 'block';
  if (ta.style.display === 'block') ta.focus();
}
function savePlayerNote(id) {
  const ta = document.getElementById(`noteText${id}`);
  const p = playerById(id);
  if (p && ta) { p.note = ta.value; scheduleSave(); }
}

// ===== CAPTAIN / VC =====
function setCaptain(id) {
  captainId = captainId === id ? null : id;
  if (captainId !== null && vcId === captainId) vcId = null;
  renderRoster(); renderField(); scheduleSave();
}
function setVC(id) {
  vcId = vcId === id ? null : id;
  if (vcId !== null && captainId === vcId) captainId = null;
  renderRoster(); renderField(); scheduleSave();
}

// ===== ADD / REMOVE PLAYER =====
function addPlayer() {
  const nameEl = document.getElementById('newPlayerName');
  const roleEl = document.getElementById('newPlayerRole');
  const name = nameEl.value.trim();
  if (!name) { nameEl.focus(); return; }
  players.push({id:nextId++, name, role:roleEl.value, note:''});
  nameEl.value = '';
  renderAll(); scheduleSave();
}
function removePlayer(id, e) {
  if(e) e.stopPropagation();
  players = players.filter(p=>p.id!==id);
  if(captainId===id) captainId=null;
  if(vcId===id) vcId=null;
  battingOrder = battingOrder.map(b=>b===id?null:b);
  bowlingSlots = bowlingSlots.map(s=>s.playerId===id?{...s,playerId:null}:s);
  fieldPositions = fieldPositions.map(fp=>fp.playerId===id?{...fp,playerId:null}:fp);
  renderAll(); scheduleSave();
}

// ===== BATTING ORDER =====
function renderBattingOrder() {
  const el = document.getElementById('battingOrder');
  el.innerHTML = '';
  for (let i=0; i<11; i++) {
    const pid = battingOrder[i];
    const p = pid ? playerById(pid) : null;
    const isCap = p && captainId===p.id;
    const isVC  = p && vcId===p.id;
    const slot = document.createElement('div');
    slot.className = 'order-slot' + (p?'':' empty');
    if (p) {
      slot.innerHTML = `
        <span class="slot-num">${i+1}</span>
        <span style="width:7px;height:7px;border-radius:50%;background:${roleColor(p.role)};display:inline-block;flex-shrink:0"></span>
        <span class="slot-name">${p.name}${isCap?' <span class="cap-badge">C</span>':''}${isVC?' <span class="vc-badge">VC</span>':''}</span>
        <span class="slot-role">${p.role}</span>
        <button class="remove-slot" onclick="removeBat(${i})">√ó</button>
      `;
    } else {
      slot.innerHTML = `<span class="slot-num">${i+1}</span><span>Drop player here</span>`;
    }
    slot.addEventListener('dragover',e=>{e.preventDefault();slot.classList.add('over')});
    slot.addEventListener('dragleave',()=>slot.classList.remove('over'));
    slot.addEventListener('drop',e=>{
      e.preventDefault();slot.classList.remove('over');
      if(dragPlayerId){
        battingOrder=battingOrder.map(b=>b===dragPlayerId?null:b);
        battingOrder[i]=dragPlayerId;
        renderBattingOrder();scheduleSave();
      }
    });
    el.appendChild(slot);
  }
}
function removeBat(i){battingOrder[i]=null;renderBattingOrder();scheduleSave();}
function clearBatting(){battingOrder=new Array(11).fill(null);renderBattingOrder();scheduleSave();}

// ===== BOWLING ORDER =====
function renderBowlingOrder() {
  const el = document.getElementById('bowlingOrder');
  el.innerHTML = '';
  bowlingSlots.forEach((slot, i) => {
    const p = slot.playerId ? playerById(slot.playerId) : null;
    const row = document.createElement('div');
    row.className = 'bowler-row';
    row.innerHTML = `
      <span class="slot-num" style="width:16px">${i+1}</span>
      <div class="order-slot" style="flex:1;margin-bottom:0" data-bslot="${i}">
        ${p?`
          <span style="width:7px;height:7px;border-radius:50%;background:${roleColor(p.role)};display:inline-block;flex-shrink:0"></span>
          <span class="slot-name">${p.name}</span>
          <button class="remove-slot" onclick="removeBowler(${i})">√ó</button>
        `:`<span style="color:var(--muted);font-size:10px;width:100%;text-align:center">Drop bowler here</span>`}
      </div>
      <input class="over-count" type="number" value="${slot.overs}" min="0" max="20" title="Overs"
        onchange="bowlingSlots[${i}].overs=parseInt(this.value)||0;scheduleSave()">
    `;
    const dz = row.querySelector(`[data-bslot="${i}"]`);
    dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over')});
    dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
    dz.addEventListener('drop',e=>{
      e.preventDefault();dz.classList.remove('over');
      if(dragPlayerId){bowlingSlots[i].playerId=dragPlayerId;renderBowlingOrder();scheduleSave();}
    });
    el.appendChild(row);
  });
}
function removeBowler(i){bowlingSlots[i].playerId=null;renderBowlingOrder();scheduleSave();}
function clearBowling(){bowlingSlots=bowlingSlots.map(s=>({...s,playerId:null}));renderBowlingOrder();scheduleSave();}
function addBowlingSlot(){bowlingSlots.push({playerId:null,overs:4});renderBowlingOrder();}

// ===== OVER PLAN =====
function buildOverPlanFromSlots(total, slots) {
  const active = slots.filter(s=>s.playerId);
  if (!active.length) return null;
  let plan=[], bi=0, used=new Array(active.length).fill(0);
  for (let ov=1; ov<=total; ov++) {
    let assigned=null;
    for (let t=0; t<active.length; t++) {
      const idx=(bi+t)%active.length;
      if(used[idx]<active[idx].overs){assigned={b:active[idx],idx};bi=(idx+1)%active.length;used[idx]++;break;}
    }
    plan.push({over:ov, player:assigned?playerById(assigned.b.playerId):null});
  }
  return plan;
}

function renderOverPlan(plan) {
  const el = document.getElementById('overPlan');
  el.innerHTML = '';
  plan.forEach(({over,player})=>{
    const row=document.createElement('div');
    row.className='order-slot';row.style.marginBottom='2px';row.style.padding='3px 8px';
    row.innerHTML=`
      <span class="slot-num" style="width:46px;color:var(--accent);font-size:10px">Over ${over}</span>
      ${player
        ?`<span style="width:7px;height:7px;border-radius:50%;background:${roleColor(player.role)};display:inline-block;flex-shrink:0"></span>
          <span class="slot-name">${player.name}</span>`
        :`<span style="color:var(--muted);font-size:10px">Unassigned</span>`}
    `;
    el.appendChild(row);
  });
}

async function generateOverPlanAI() {
  const total = parseInt(document.getElementById('totalOvers').value)||20;
  const el = document.getElementById('overPlan');

  if (lastAIJson && lastAIJson.bowlingRotation && lastAIJson.bowlingRotation.length) {
    const aiSlots = lastAIJson.bowlingRotation.map(b => {
      const p = players.find(pl=>pl.name===b.name);
      return { playerId: p?p.id:null, overs: b.overs||4 };
    }).filter(s=>s.playerId);

    if (aiSlots.length) {
      const plan = buildOverPlanFromSlots(total, aiSlots);
      if (plan) {
        el.innerHTML = `<div style="background:rgba(124,58,237,.12);border:1px solid rgba(167,139,250,.25);border-radius:4px;padding:5px 8px;margin-bottom:6px;font-size:10px;color:#a78bfa">‚ú® Generated from AI bowling suggestions</div>`;
        const wrapper = document.createElement('div');
        el.appendChild(wrapper);
        plan.forEach(({over,player})=>{
          const row=document.createElement('div');
          row.className='order-slot';row.style.marginBottom='2px';row.style.padding='3px 8px';
          row.innerHTML=`
            <span class="slot-num" style="width:46px;color:var(--accent);font-size:10px">Over ${over}</span>
            ${player
              ?`<span style="width:7px;height:7px;border-radius:50%;background:${roleColor(player.role)};display:inline-block;flex-shrink:0"></span>
                <span class="slot-name">${player.name}</span>`
              :`<span style="color:var(--muted);font-size:10px">Unassigned</span>`}
          `;
          wrapper.appendChild(row);
        });
        return;
      }
    }
  }

  const active = bowlingSlots.filter(s=>s.playerId);
  if (!active.length) {
    el.innerHTML=`<div class="info-box">No bowlers assigned. Either run <strong>AI Suggestions</strong> from the ü§ñ AI tab, or drag bowlers into the Bowling Rotation above.</div>`;
    return;
  }
  const plan = buildOverPlanFromSlots(total, bowlingSlots);
  el.innerHTML = `<div style="background:rgba(240,165,0,.07);border:1px solid rgba(240,165,0,.18);border-radius:4px;padding:5px 8px;margin-bottom:6px;font-size:10px;color:var(--muted)">Generated from manual bowling rotation ‚Äî run ü§ñ AI for smarter suggestions</div>`;
  const wrapper = document.createElement('div');
  el.appendChild(wrapper);
  plan.forEach(({over,player})=>{
    const row=document.createElement('div');
    row.className='order-slot';row.style.marginBottom='2px';row.style.padding='3px 8px';
    row.innerHTML=`
      <span class="slot-num" style="width:46px;color:var(--accent);font-size:10px">Over ${over}</span>
      ${player
        ?`<span style="width:7px;height:7px;border-radius:50%;background:${roleColor(player.role)};display:inline-block;flex-shrink:0"></span>
          <span class="slot-name">${player.name}</span>`
        :`<span style="color:var(--muted);font-size:10px">Unassigned</span>`}
    `;
    wrapper.appendChild(row);
  });
}

// ===== FIELD =====
function renderField() {
  const container = document.getElementById('fieldTokens');
  container.innerHTML = '';
  Object.assign(container.style,{position:'absolute',top:'0',left:'0',width:'100%',height:'100%',pointerEvents:'none'});

  fieldPositions.forEach((fp, i) => {
    const p = fp.playerId ? playerById(fp.playerId) : null;
    const color = p ? roleColor(p.role) : (i===0?'#b57c10':'#1e3a5a');
    const isCap = p && captainId===p.id;
    const isVC  = p && vcId===p.id;

    const tok = document.createElement('div');
    tok.className = 'fielder-token';
    tok.style.cssText = `left:${fp.x}%;top:${fp.y}%;background:${color};border:2px solid ${p?'rgba(255,255,255,.4)':'rgba(255,255,255,.1)'};pointer-events:all`;
    tok.innerHTML = `
      ${isCap?`<div class="tok-badge" style="background:#f0a500;color:#000">C</div>`:isVC?`<div class="tok-badge" style="background:#8b5cf6;color:#fff">V</div>`:''}
      <div class="tok-name">${p?shortName(p.name):(i===0?'WK':'¬∑')}</div>
      <div class="tok-pos">${fp.posName}</div>
    `;

    makeFieldDraggable(tok, i);

    tok.addEventListener('contextmenu', e=>{e.preventDefault();openPosPopup(i, e);});
    tok.addEventListener('dragover', e=>{e.preventDefault();tok.style.boxShadow='0 0 0 3px #f0a500';});
    tok.addEventListener('dragleave', ()=>tok.style.boxShadow='');
    tok.addEventListener('drop', e=>{
      e.preventDefault();tok.style.boxShadow='';
      if(dragPlayerId){
        fieldPositions=fieldPositions.map((fp2,j)=>j!==i&&fp2.playerId===dragPlayerId?{...fp2,playerId:null}:fp2);
        fieldPositions[i].playerId=dragPlayerId;
        renderField();scheduleSave();
      }
    });
    container.appendChild(tok);
  });
}

function makeFieldDraggable(el, idx) {
  el.addEventListener('mousedown', e=>{
    if(dragPlayerId||e.button!==0) return;
    e.preventDefault();
    const wrap=document.getElementById('fieldWrap');
    const rect=wrap.getBoundingClientRect();
    const sx=e.clientX, sy=e.clientY;
    const sl=fieldPositions[idx].x, st=fieldPositions[idx].y;

    function onMove(e){
      const nx=Math.max(5,Math.min(95,sl+((e.clientX-sx)/rect.width)*100));
      const ny=Math.max(5,Math.min(95,st+((e.clientY-sy)/rect.height)*100));
      fieldPositions[idx].x=nx;
      fieldPositions[idx].y=ny;
      el.style.left=nx+'%';
      el.style.top=ny+'%';
      const name=detectPosition(nx,ny);
      fieldPositions[idx].posName=name;
      const posEl=el.querySelector('.tok-pos');
      if(posEl) posEl.textContent=name;
    }
    function onUp(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);scheduleSave();}
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  });
}

// ===== POSITION POPUP =====
function openPosPopup(idx, e) {
  editingPosIdx = idx;
  const popup = document.getElementById('posPopup');
  const wrap = document.getElementById('fieldWrap');
  const wr = wrap.getBoundingClientRect();
  const px = Math.min(e.clientX-wr.left, wr.width-185);
  const py = Math.max(0, e.clientY-wr.top-90);
  popup.style.cssText = `display:block;left:${px}px;top:${py}px`;
  document.getElementById('posNameInput').value = fieldPositions[idx].posName;
  document.getElementById('posNameInput').focus();
  document.getElementById('posNameInput').select();
}
function confirmPosName() {
  if(editingPosIdx===null) return;
  const v=document.getElementById('posNameInput').value.trim();
  if(v){fieldPositions[editingPosIdx].posName=v;renderField();scheduleSave();}
  closePosPopup();
}
function closePosPopup(){document.getElementById('posPopup').style.display='none';editingPosIdx=null;}
document.addEventListener('keydown',e=>{if(e.key==='Escape') closePosPopup();});

// ===== PRESETS =====
const presets={
  attack:[[50,22],[61,20],[73,30],[79,44],[75,57],[68,67],[60,78],[40,78],[28,67],[22,50],[37,22]],
  defend:[[50,22],[61,20],[80,42],[82,55],[72,68],[62,78],[55,84],[45,84],[33,72],[18,52],[37,22]],
  spin:  [[50,22],[63,20],[75,28],[80,42],[73,55],[62,67],[56,78],[44,78],[30,67],[20,48],[36,22]],
};
function applyPreset(v){
  if(!presets[v]) return;
  presets[v].forEach((pos,i)=>{fieldPositions[i].x=pos[0];fieldPositions[i].y=pos[1];fieldPositions[i].posName=detectPosition(pos[0],pos[1]);});
  renderField();scheduleSave();
}
function resetFieldAssignments(){fieldPositions=fieldPositions.map(fp=>({...fp,playerId:null}));renderField();scheduleSave();}
function resetAllPositions(){
  const d=[[50,22],[61,20],[73,30],[79,44],[75,57],[68,67],[60,78],[40,78],[28,67],[22,50],[37,22]];
  fieldPositions=fieldPositions.map((fp,i)=>({...fp,x:d[i][0],y:d[i][1],posName:detectPosition(d[i][0],d[i][1])}));
  renderField();scheduleSave();
}

// ===== TABS =====
function switchTab(name){
  ['batting','bowling','notes','ai'].forEach((t,i)=>{
    document.querySelectorAll('.tab')[i].classList.toggle('active',t===name);
    document.getElementById('tab-'+t).classList.toggle('active',t===name);
  });
}

// ===== EXPORT =====
function exportPlan(){
  const team=document.getElementById('teamName').value||'My Team';
  const opp=document.getElementById('opponent').value||'Opponent';
  const type=document.getElementById('matchType').value;
  let txt=`=== CRICKET STRATEGY PLAN ===\n${team} vs ${opp} | ${type}\n`;
  const cap=captainId?playerById(captainId):null;
  const vc=vcId?playerById(vcId):null;
  if(cap) txt+=`Captain: ${cap.name}\n`;
  if(vc)  txt+=`Vice-Captain: ${vc.name}\n`;
  txt+='\n--- BATTING ORDER ---\n';
  battingOrder.forEach((pid,i)=>{const p=pid?playerById(pid):null;txt+=`${i+1}. ${p?p.name+' ('+p.role+')'  :'(empty)'}\n`;});
  txt+='\n--- BOWLING ORDER ---\n';
  bowlingSlots.forEach((s,i)=>{const p=s.playerId?playerById(s.playerId):null;txt+=`${i+1}. ${p?p.name+' - '+s.overs+' overs':'(empty)'}\n`;});
  txt+='\n--- FIELD POSITIONS ---\n';
  fieldPositions.forEach(fp=>{const p=fp.playerId?playerById(fp.playerId):null;txt+=`${fp.posName}: ${p?p.name:'(unassigned)'}\n`;});
  txt+='\n--- PLAYER NOTES ---\n';
  players.forEach(p=>{if(p.note&&p.note.trim()) txt+=`${p.name}: ${p.note.trim()}\n`;});
  const ns=document.getElementById('noteStrategy').value;
  const nb=document.getElementById('noteBatting').value;
  const nbo=document.getElementById('noteBowling').value;
  if(ns.trim()) txt+=`\n[Match Strategy]\n${ns}\n`;
  if(nb.trim()) txt+=`\n[Batting Notes]\n${nb}\n`;
  if(nbo.trim()) txt+=`\n[Bowling Notes]\n${nbo}\n`;
  const blob=new Blob([txt],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`cricket-plan-${team.replace(/\s/g,'_')}.txt`;
  a.click();
}

// ===== GROQ AI =====
function safeParseJSON(raw) {
  let s = raw.trim();
  s = s.replace(/^```[a-zA-Z]*\s*/m, '').replace(/\s*```\s*$/m, '').trim();
  s = s.replace(/^`+/, '').replace(/`+$/, '').trim();
  const firstBrace = s.indexOf('{');
  const firstBracket = s.indexOf('[');
  let start = -1;
  if (firstBrace !== -1 && firstBracket !== -1) start = Math.min(firstBrace, firstBracket);
  else if (firstBrace !== -1) start = firstBrace;
  else if (firstBracket !== -1) start = firstBracket;
  const lastBrace = s.lastIndexOf('}');
  const lastBracket = s.lastIndexOf(']');
  const end = Math.max(lastBrace, lastBracket);
  if (start !== -1 && end !== -1 && end > start) s = s.slice(start, end + 1);
  return JSON.parse(s);
}
let lastAIJson = null;

function toValidSquadName(name, validMap) {
  const key = String(name || '').trim().toLowerCase();
  if (!key) return null;
  return validMap.get(key) || null;
}

function countInvalidAINameEntries(json, validMap) {
  let count = 0;
  const isInvalid = (name) => !toValidSquadName(name, validMap);
  if (Array.isArray(json?.battingOrder)) json.battingOrder.forEach(b => { if (isInvalid(b?.name)) count++; });
  if (Array.isArray(json?.bowlingRotation)) json.bowlingRotation.forEach(b => { if (isInvalid(b?.name)) count++; });
  const phases = json?.fieldingPhases;
  if (phases) {
    ['powerplay', 'middleOvers', 'deathOvers'].forEach(k => {
      const fielders = phases[k]?.fielders;
      if (Array.isArray(fielders)) fielders.forEach(f => { if (isInvalid(f?.name)) count++; });
    });
  }
  return count;
}

function getFieldingTemplate(phaseKey) {
  const templates = {
    powerplay: [
      { position: 'Wicket-keeper', zone: 'inside' },
      { position: 'First Slip', zone: 'inside' },
      { position: 'Second Slip', zone: 'inside' },
      { position: 'Point', zone: 'inside' },
      { position: 'Cover Point', zone: 'inside' },
      { position: 'Mid Off', zone: 'inside' },
      { position: 'Mid On', zone: 'inside' },
      { position: 'Square Leg', zone: 'inside' },
      { position: 'Third Man', zone: 'outside' },
      { position: 'Fine Leg', zone: 'outside' }
    ],
    middleOvers: [
      { position: 'Wicket-keeper', zone: 'inside' },
      { position: 'Point', zone: 'inside' },
      { position: 'Cover Point', zone: 'inside' },
      { position: 'Extra Cover', zone: 'inside' },
      { position: 'Mid Off', zone: 'inside' },
      { position: 'Mid On', zone: 'inside' },
      { position: 'Square Leg', zone: 'inside' },
      { position: 'Long Off', zone: 'outside' },
      { position: 'Long On', zone: 'outside' },
      { position: 'Deep Mid Wicket', zone: 'outside' }
    ],
    deathOvers: [
      { position: 'Wicket-keeper', zone: 'inside' },
      { position: 'Point', zone: 'inside' },
      { position: 'Cover', zone: 'inside' },
      { position: 'Mid Off', zone: 'inside' },
      { position: 'Mid On', zone: 'inside' },
      { position: 'Long Off', zone: 'outside' },
      { position: 'Long On', zone: 'outside' },
      { position: 'Deep Extra Cover', zone: 'outside' },
      { position: 'Deep Mid Wicket', zone: 'outside' },
      { position: 'Third Man', zone: 'outside' }
    ]
  };
  return templates[phaseKey] || templates.middleOvers;
}

function sanitizeAIResponse(json, aiPlayers, matchType) {
  const validMap = new Map(aiPlayers.map(p => [p.name.toLowerCase(), p.name]));
  const playerCount = aiPlayers.length;
  const maxBatters = Math.max(1, playerCount);
  const isShortFormat = matchType === 'T20' || matchType === 'T10';
  const maxBowlerOvers = isShortFormat ? 4 : 10;

  const out = {
    battingOrder: [],
    bowlingRotation: [],
    fieldingPhases: {
      powerplay: { overs: '1-6', maxOutside: 2, note: 'Attacking field with pressure in ring', fielders: [] },
      middleOvers: { overs: '7-15', maxOutside: 4, note: 'Contain runs and create mistakes', fielders: [] },
      deathOvers: { overs: '16-20', maxOutside: 5, note: 'Protect boundaries and hit yorker plans', fielders: [] }
    },
    coachTip: json?.coachTip || 'Use player notes to match roles to phases and keep plans simple.'
  };

  const usedBatNames = new Set();
  const rawBat = Array.isArray(json?.battingOrder) ? [...json.battingOrder] : [];
  rawBat.sort((a, b) => (parseInt(a?.position) || 999) - (parseInt(b?.position) || 999));
  for (let pos = 1; pos <= maxBatters; pos++) {
    const row = rawBat.find(b => (parseInt(b?.position) || 0) === pos);
    let chosen = row ? toValidSquadName(row.name, validMap) : null;
    if (chosen && usedBatNames.has(chosen)) chosen = null;
    if (!chosen) {
      const next = aiPlayers.find(p => !usedBatNames.has(p.name));
      chosen = next ? next.name : aiPlayers[(pos - 1) % aiPlayers.length].name;
    }
    usedBatNames.add(chosen);
    out.battingOrder.push({ name: chosen, position: pos, reason: row?.reason || 'Placed based on role and available player notes.' });
  }

  const preferred = aiPlayers.filter(p => p.role === 'Bowler' || p.role === 'All-rounder');
  const fallbackPool = preferred.length ? preferred : aiPlayers;
  const usedBowl = new Set();
  const rawBowl = Array.isArray(json?.bowlingRotation) ? json.bowlingRotation : [];

  rawBowl.forEach(b => {
    const name = toValidSquadName(b?.name, validMap);
    if (!name || usedBowl.has(name)) return;
    usedBowl.add(name);
    out.bowlingRotation.push({ name, overs: Math.max(1, Math.min(maxBowlerOvers, parseInt(b?.overs) || (isShortFormat ? 4 : 5))), reason: b?.reason || 'Selected for bowling responsibility.' });
  });

  while (out.bowlingRotation.length < Math.min(5, fallbackPool.length)) {
    const next = fallbackPool.find(p => !usedBowl.has(p.name));
    if (!next) break;
    usedBowl.add(next.name);
    out.bowlingRotation.push({ name: next.name, overs: isShortFormat ? 4 : 5, reason: 'Added from squad role balance.' });
  }

  const phaseKeys = ['powerplay', 'middleOvers', 'deathOvers'];
  const phaseDefaults = { powerplay: { overs: '1-6', maxOutside: 2 }, middleOvers: { overs: '7-15', maxOutside: 4 }, deathOvers: { overs: '16-20', maxOutside: 5 } };

  phaseKeys.forEach(key => {
    const src = json?.fieldingPhases?.[key] || {};
    const maxOutside = parseInt(src.maxOutside) || phaseDefaults[key].maxOutside;
    const targetCount = Math.min(11, Math.max(1, aiPlayers.length));
    const rawFielders = Array.isArray(src.fielders) ? src.fielders : [];
    const template = getFieldingTemplate(key);
    const used = new Set();
    const fielders = [];

    rawFielders.forEach(f => {
      if (fielders.length >= targetCount) return;
      const name = toValidSquadName(f?.name, validMap);
      if (!name || used.has(name)) return;
      used.add(name);
      const tpl = template[fielders.length % template.length];
      const position = (f?.position && String(f.position).trim()) ? String(f.position).trim() : tpl.position;
      fielders.push({ name, position, zone: f?.zone === 'outside' ? 'outside' : (tpl.zone || 'inside'), reason: f?.reason || 'Role-based placement.' });
    });

    while (fielders.length < targetCount) {
      const next = aiPlayers.find(p => !used.has(p.name));
      if (!next) break;
      used.add(next.name);
      const tpl = template[fielders.length % template.length];
      fielders.push({ name: next.name, position: tpl.position, zone: tpl.zone, reason: `Auto-filled from squad for ${tpl.position}.` });
    }

    let outsideSeen = 0;
    fielders.forEach(f => {
      if (f.zone === 'outside') { outsideSeen++; if (outsideSeen > maxOutside) f.zone = 'inside'; }
    });

    out.fieldingPhases[key] = { overs: src.overs || phaseDefaults[key].overs, maxOutside, note: src.note || out.fieldingPhases[key].note, fielders };
  });

  return out;
}

async function getAISquadForAI() {
  try {
    const res = await fetch(JSONBIN_URL + '/latest', { headers: { 'X-Master-Key': JSONBIN_KEY } });
    if (!res.ok) throw new Error('Cloud squad fetch failed');
    const data = await res.json();
    const cloudPlayers = data?.record?.players;
    if (Array.isArray(cloudPlayers) && cloudPlayers.length) {
      return cloudPlayers.map((p, idx) => ({ id: p.id ?? idx + 1, name: String(p.name || '').trim(), role: p.role || 'Batsman', note: p.note || '' })).filter(p => p.name);
    }
  } catch (e) {}
  return players.map(p => ({ id: p.id, name: p.name, role: p.role, note: p.note || '' }));
}

async function askGroq() {
  const aiPlayers = await getAISquadForAI();
  if (!aiPlayers.length) { alert('Add players to your roster first!'); return; }

  const localCaptainName = captainId ? playerById(captainId)?.name : null;
  const localVCName = vcId ? playerById(vcId)?.name : null;
  const playerNames = aiPlayers.map(p => p.name);
  const playerSummary = aiPlayers.map((p,i) => {
    const isCap = localCaptainName && p.name === localCaptainName ? ' [CAPTAIN]' : '';
    const isVC  = localVCName && p.name === localVCName ? ' [VICE-CAPTAIN]' : '';
    const note  = p.note && p.note.trim() ? ' | Notes: "' + p.note.trim() + '"' : ' | No notes';
    return (i+1) + '. NAME: ' + p.name + ' | ROLE: ' + p.role + isCap + isVC + note;
  }).join('\n');

  const playerCount = aiPlayers.length;
  const matchType = document.getElementById('matchType').value;
  const context   = document.getElementById('aiContext').value.trim();
  const matchMeta = (document.getElementById('teamName').value||'My Team') + ' vs ' + (document.getElementById('opponent').value||'Opponent') + ' | ' + matchType;
  const isT20 = matchType === 'T20' || matchType === 'T10';

  // Updated position names in prompt to match reference map
  const prompt = `You are an expert cricket coach AI. You must strictly follow these rules.

Match: ${matchMeta}
${context ? 'Context: ' + context : ''}
Match Type: ${matchType}

=== YOUR SQUAD (USE ONLY THESE EXACT NAMES) ===
${playerSummary}

VALID PLAYER NAMES LIST: ${playerNames.join(', ')}

‚ö†Ô∏è CRITICAL: Use ONLY the exact player names listed above. NEVER invent names.

VALID FIELDING POSITIONS (use ONLY these names from the reference diagram):
Inner ring: Wicket-keeper, First Slip, Second Slip, Third Slip, Leg Slip, Leg Gully, Gully, Point, Cover Point, Cover, Extra Cover, Mid Off, Mid On, Mid Wicket, InField, Square Leg, Silly Mid On, Silly Mid Off
Boundary/Outfield: Third Man, Deep Fine Leg, Fine Leg, Deep Point, OutField, Deep Extra Cover, Long Off, Long On, Deep Mid Wicket, Deep Square, Deep Square Leg

INSTRUCTIONS:
1. BATTING ORDER: List ALL ${playerCount} players using their EXACT names.
2. BOWLING ROTATION: Use EXACT player names. In T20: max 4 overs per bowler.
3. FIELDING PLAN: Use EXACT player names AND ONLY the valid position names listed above for all 3 phases.
   - Powerplay: ONLY 2 outside circle max.
   - Middle: max 4 outside.
   - Death: max 5 outside.

Respond ONLY with raw JSON (no markdown, no code fences):
{
  "battingOrder": [{"name": "Player Name", "position": 1, "reason": "brief reason"}],
  "bowlingRotation": [{"name": "Player Name", "overs": 1, "reason": "brief reason"}],
  "fieldingPhases": {
    "powerplay": {
      "overs": "1-6", "maxOutside": 2, "note": "tactical note",
      "fielders": [{"name": "Player Name", "position": "Cover Point", "zone": "inside", "reason": "brief"}]
    },
    "middleOvers": {
      "overs": "7-15", "maxOutside": 4, "note": "tactical note",
      "fielders": [{"name": "Player Name", "position": "Mid Wicket", "zone": "inside", "reason": "brief"}]
    },
    "deathOvers": {
      "overs": "16-20", "maxOutside": 5, "note": "tactical note",
      "fielders": [{"name": "Player Name", "position": "Long On", "zone": "outside", "reason": "brief"}]
    }
  },
  "coachTip": "One overall tactical tip for this match"
}`;

  document.getElementById('aiLoading').style.display = 'block';
  document.getElementById('aiResult').style.display = 'none';
  const bar = document.getElementById('aiLoadBar');
  bar.style.width = '0%';
  setTimeout(()=>bar.style.width='85%', 50);

  try {
    const res = await fetch(GROQ_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_API_KEY}` },
      body: JSON.stringify({ model: GROQ_MODEL, messages: [{ role: 'user', content: prompt }], temperature: 0.6, max_tokens: 4000 })
    });

    const data = await res.json();
    bar.style.width = '100%';
    if (!res.ok) throw new Error(data.error?.message || 'Groq API error');

    const raw = data.choices[0].message.content.trim();
    const json = safeParseJSON(raw);
    const validMap = new Map(aiPlayers.map(p => [p.name.toLowerCase(), p.name]));
    const invalidBefore = countInvalidAINameEntries(json, validMap);
    const cleaned = sanitizeAIResponse(json, aiPlayers, matchType);
    if (invalidBefore > 0) cleaned.coachTip = `Auto-corrected ${invalidBefore} non-squad name entr${invalidBefore===1?'y':'ies'} to your squad. ` + (cleaned.coachTip || '');
    lastAIJson = cleaned;

    setTimeout(()=>{
      document.getElementById('aiLoading').style.display = 'none';
      renderAIResult(cleaned);
    }, 400);

  } catch(e) {
    document.getElementById('aiLoading').style.display = 'none';
    document.getElementById('aiResult').style.display = 'block';
    document.getElementById('aiResultBody').innerHTML = `<span style="color:var(--red)">Error: ${e.message}</span>`;
  }
}

function renderFieldPhase(phase, data, phaseColor) {
  if (!data || !data.fielders) return '';
  const outsideCount = data.fielders.filter(f => f.zone === 'outside').length;
  const limitBreached = outsideCount > (data.maxOutside || 99);
  const phaseLabel = phase === 'powerplay' ? '‚ö° Powerplay' : phase === 'middleOvers' ? 'üîÑ Middle Overs' : 'üíÄ Death Overs';
  const limitColor = limitBreached ? '#e03030' : phaseColor;

  let html = `<div class="ai-section" style="margin-bottom:8px">
    <div class="ai-section-title" style="background:${phaseColor}18;color:${phaseColor};flex-wrap:wrap;gap:4px">
      ${phaseLabel}
      <span style="opacity:.7;font-size:9px">Overs ${data.overs||''}</span>
      <span style="margin-left:auto;font-size:9px;background:${limitColor}22;padding:1px 7px;border-radius:10px;color:${limitColor};font-weight:700">
        ${outsideCount}/${data.maxOutside} outside ${limitBreached ? '‚ö†Ô∏è OVER LIMIT' : '‚úì'}
      </span>
    </div>`;

  if (data.note) {
    html += `<div style="background:${phaseColor}10;border-left:2px solid ${phaseColor};padding:4px 8px;font-size:10px;color:var(--muted);font-style:italic">${data.note}</div>`;
  }

  html += `<div class="ai-section-body" style="padding:6px 8px">`;

  if (phase === 'powerplay') {
    html += `<div style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);border-radius:3px;padding:4px 7px;font-size:9px;color:#f59e0b;margin-bottom:6px;line-height:1.5">
      ‚ö° <strong>Powerplay:</strong> MAX 2 outside circle ¬∑ Min 2 catching positions ¬∑ No fielder within 10m of bat
    </div>`;
  }
  if (phase === 'deathOvers') {
    html += `<div style="background:rgba(224,48,48,.07);border:1px solid rgba(224,48,48,.2);border-radius:3px;padding:4px 7px;font-size:9px;color:#e03030;margin-bottom:6px;line-height:1.5">
      üíÄ <strong>Death:</strong> MAX 5 outside circle ¬∑ Protect boundaries
    </div>`;
  }

  const inside = data.fielders.filter(f => f.zone !== 'outside');
  const outside = data.fielders.filter(f => f.zone === 'outside');

  if (inside.length) {
    html += `<div style="font-size:9px;color:#10b981;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px;font-family:Oswald,sans-serif;display:flex;align-items:center;gap:4px">
      <span style="width:6px;height:6px;border-radius:50%;background:#10b981;display:inline-block"></span> Inside circle (${inside.length})
    </div>`;
    inside.forEach(f => {
      const p = players.find(pl => pl.name === f.name);
      const col = p ? roleColor(p.role) : '#10b981';
      html += `<div class="ai-player-row">
        <span style="width:7px;height:7px;border-radius:50%;background:${col};flex-shrink:0;display:inline-block"></span>
        <span style="font-weight:600;flex:1;font-size:11px">${f.name}</span>
        <span class="ai-pos-tag" style="background:rgba(16,185,129,.15);color:#10b981">${f.position}</span>
        <span style="color:var(--muted);font-size:9px;margin-left:5px;max-width:75px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap" title="${f.reason||''}">${f.reason||''}</span>
      </div>`;
    });
  }

  if (outside.length) {
    html += `<div style="font-size:9px;color:#f59e0b;text-transform:uppercase;letter-spacing:.5px;margin:6px 0 3px;font-family:Oswald,sans-serif;border-top:1px solid var(--border);padding-top:5px;display:flex;align-items:center;gap:4px">
      <span style="width:6px;height:6px;border-radius:50%;background:#f59e0b;display:inline-block"></span> Boundary (${outside.length}/${data.maxOutside} max)
      ${limitBreached ? '<span style="color:#e03030;font-weight:700;margin-left:4px">‚ö†Ô∏è EXCEEDS LIMIT</span>' : ''}
    </div>`;
    outside.forEach(f => {
      const p = players.find(pl => pl.name === f.name);
      const col = p ? roleColor(p.role) : '#f59e0b';
      html += `<div class="ai-player-row">
        <span style="width:7px;height:7px;border-radius:50%;background:${col};flex-shrink:0;display:inline-block"></span>
        <span style="font-weight:600;flex:1;font-size:11px">${f.name}</span>
        <span class="ai-pos-tag" style="background:rgba(245,158,11,.15);color:#f59e0b">${f.position}</span>
        <span style="color:var(--muted);font-size:9px;margin-left:5px;max-width:75px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap" title="${f.reason||''}">${f.reason||''}</span>
      </div>`;
    });
  }

  html += `</div></div>`;
  return html;
}

function renderAIResult(json) {
  const el = document.getElementById('aiResult');
  const body = document.getElementById('aiResultBody');
  el.style.display = 'block';

  let html = '';

  if (json.battingOrder) {
    html += `<div class="ai-section">
      <div class="ai-section-title">üèè Recommended Batting Order</div>
      <div class="ai-section-body">`;
    json.battingOrder.forEach(b => {
      const p = players.find(pl=>pl.name===b.name);
      const color = p ? roleColor(p.role) : '#10b981';
      html += `<div class="ai-player-row">
        <span style="font-family:'Oswald',sans-serif;font-size:11px;color:var(--accent);width:18px;flex-shrink:0">${b.position}.</span>
        <span style="width:8px;height:8px;border-radius:50%;background:${color};flex-shrink:0;display:inline-block"></span>
        <span style="font-weight:600;flex:1">${b.name}</span>
        <span style="color:var(--muted);font-size:10px">${b.reason}</span>
      </div>`;
    });
    html += `</div></div>`;
  }

  if (json.bowlingRotation) {
    html += `<div class="ai-section">
      <div class="ai-section-title">üé≥ Bowling Rotation</div>
      <div class="ai-section-body">`;
    json.bowlingRotation.forEach(b => {
      const p = players.find(pl=>pl.name===b.name);
      const color = p ? roleColor(p.role) : '#3b82f6';
      html += `<div class="ai-player-row">
        <span style="width:8px;height:8px;border-radius:50%;background:${color};flex-shrink:0;display:inline-block"></span>
        <span style="font-weight:600;flex:1">${b.name}</span>
        <span class="ai-pos-tag">${b.overs} ovs</span>
        <span style="color:var(--muted);font-size:10px;margin-left:6px">${b.reason}</span>
      </div>`;
    });
    html += `</div></div>`;
  }

  if (json.fieldingPhases) {
    html += `<div style="font-family:Oswald,sans-serif;font-size:10px;letter-spacing:1px;color:#a78bfa;text-transform:uppercase;padding:6px 0 4px;border-bottom:1px solid var(--border);margin-bottom:6px">
      üèüÔ∏è Fielding Plan ‚Äî Phase Restrictions
    </div>`;
    html += renderFieldPhase('powerplay', json.fieldingPhases.powerplay, '#f59e0b');
    html += renderFieldPhase('middleOvers', json.fieldingPhases.middleOvers, '#10b981');
    html += renderFieldPhase('deathOvers', json.fieldingPhases.deathOvers, '#e03030');
  }

  if (json.coachTip) {
    html += `<div style="background:rgba(240,165,0,.08);border:1px solid rgba(240,165,0,.2);border-radius:5px;padding:8px 10px;margin-top:6px;font-size:11px;color:var(--accent)">
      üí° <strong>Coach Tip:</strong> ${json.coachTip}
    </div>`;
  }

  body.innerHTML = html;
}

function applyAISuggestions() {
  if (!lastAIJson) return;
  let applied = [];

  if (lastAIJson.battingOrder) {
    const newOrder = new Array(11).fill(null);
    lastAIJson.battingOrder.forEach(b => {
      const p = players.find(pl => pl.name === b.name);
      if (p && b.position >= 1 && b.position <= 11) newOrder[b.position - 1] = p.id;
    });
    battingOrder = newOrder;
    applied.push('batting order');
  }

  if (lastAIJson.bowlingRotation) {
    bowlingSlots = lastAIJson.bowlingRotation.map(b => {
      const p = players.find(pl => pl.name === b.name);
      return { playerId: p ? p.id : null, overs: b.overs || 4 };
    });
    applied.push('bowling rotation');
  }

  renderAll();
  scheduleSave();
  alert(`‚úì Applied AI suggestions: ${applied.join(' & ')}.\n\nCheck Batting and Bowling tabs!`);
  switchTab('batting');
}

// ===== RENDER ALL =====
function renderAll(){renderRoster();renderBattingOrder();renderBowlingOrder();renderField();}
</script>
</body>
</html>
